@startuml
'https://plantuml.com/sequence-diagram

autonumber

Actor ":AGVManager" as AGVM
participant ":TcpSrvSum" as UI
participant ":AutomaticallyAssignOrderToFreeAGVController" as CTRL
participant ":PersistenceContext" as Persistance
participant ":RepositoryFactory" as Factory
participant ":OrderRepository" as OrderRep
participant ":AGVRepository" as AGVRep
participant ":TaskRepository" as TaskRep
participant ":TheOrder" as ORDER
participant ":AGV" as AGV
participant ":TheTask" as Task

activate AGVM
AGVM -> UI : automatically request to assign available orders to available AGVs
activate UI
UI -> CTRL : create
activate CTRL
|||
deactivate CTRL
UI -> CTRL : getOrdersToAssign
activate CTRL
CTRL -> Persistance : repositories()
activate Persistance
Persistance -> Factory : create
activate Factory
Factory -> OrderRep : create
activate OrderRep
|||
deactivate OrderRep
deactivate Factory
deactivate Persistance
CTRL -> OrderRep : findByOrderStatus(TO_BE_PREPARED)
activate OrderRep
OrderRep --> CTRL : ordersToAssign
deactivate OrderRep
CTRL --> UI : ordersToAssign
deactivate CTRL
UI -> CTRL : getAvailableAGVs
activate CTRL
CTRL -> Persistance : repositories()
activate Persistance
Persistance -> Factory : create
activate Factory
Factory -> AGVRep : create
activate AGVRep
|||
deactivate AGVRep
deactivate Factory
deactivate Persistance
CTRL -> AGVRep : findByTaskStatus(FREE)
activate AGVRep
AGVRep --> CTRL : availableAGVs
deactivate AGVRep
CTRL --> UI : availableAGVs
deactivate CTRL

alt for each pair or ordersToAssign and availableAGVs
UI -> UI : selectedOrder
UI -> UI : selectedAGV

UI -> CTRL : registerTask(selectedAGV, selectedOrder)
activate CTRL
CTRL -> Task : newTask = create(selectedAGV, selectedOrder)
activate Task
|||
deactivate Task
CTRL -> Persistance : repositories()
activate Persistance
Persistance -> Factory : create
activate Factory
Factory -> TaskRep : create
activate TaskRep
|||
deactivate TaskRep
deactivate Factory
deactivate Persistance
CTRL -> TaskRep : save(newTask)
activate TaskRep
|||
deactivate TaskRep
deactivate CTRL

UI -> ORDER : setStatus(BEING_PREPARED_ON_WAREHOUSE)
activate ORDER
ORDER --> UI : selectedOrder
deactivate ORDER
UI -> CTRL : updateOrder(selectedOrder)
activate CTRL
|||
deactivate CTRL
UI -> AGV : setTaskStatus(OCCUPIED)
activate AGV
AGV --> UI : selectedAGV
deactivate AGV
UI -> CTRL : updateAGV(selectedAGV)
activate CTRL
|||
deactivate CTRL

end


UI --> AGVM : informs which orders were assigned to which AGVs
deactivate UI
deactivate AGVM

@enduml